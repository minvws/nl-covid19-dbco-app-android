default_platform(:android)

platform :android do
    desc "Runs all the tests"
    lane :test do
        gradle(task: "test")
    end

    desc "Executes Android lint"
    lane :lint do
        gradle(task: "lintAccRelease")
    end

    desc "Builds and distributes app via firebase"
    lane :distribute do

        versionName = build_version_name()

        build_android_app(
            task: "assemble",
            flavor: "Acc",
            build_type: "Release"
        )

        firebase_app_distribution(
            app: "1:14711935107:android:5ef53bbc991b05c1074bb6",
            firebase_cli_token: ENV["FIREBASE_CLI_TOKEN"],
            groups: "testers",
            release_notes: "Release via Firebase"
        )

        inform_slack(
            default_payloads: [:git_author],
            message: "Successfully distributed beta build #{versionName} (ENV['GITHUB_RUN_NUMBER']) :rocket:",
        )
    end

    lane :build_version_name do
        value = get_version_name(
            gradle_file_path:"app/build.gradle",
            ext_constant_name:"versionName"
            )
        puts "VALUE = #{value}"
    end

    private_lane :inform_slack do |options|
        unless ENV['SLACK_URL'].nil?
            slack(options)
        end
    end
end
